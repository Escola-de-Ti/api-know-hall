#!/bin/bash

# Hook para validar mensagens de commit seguindo Conventional Commits
# Este script valida se a mensagem de commit segue o padrÃ£o Conventional Commits

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Arquivo da mensagem de commit
commit_msg_file=$1
commit_msg=$(cat $commit_msg_file)

# FunÃ§Ã£o para imprimir mensagens coloridas
print_error() {
    echo -e "${RED}âŒ ERRO: $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# PadrÃ£o para Conventional Commits com emoji opcional
# Formato: [emoji] tipo(escopo): descriÃ§Ã£o
conventional_pattern="^(ğŸ‰|ğŸš€|âœ¨|ğŸ›|ğŸ”§|ğŸ“|ğŸ’„|ğŸ”¥|â™»ï¸|âš¡|ğŸ¨|ğŸ“¦|ğŸ”’|ğŸš¨|ğŸ—ï¸|ğŸ’š|ğŸ‘·|ğŸ“ˆ|ğŸ”–|ğŸš‘|ğŸ’¥|ğŸ±|â™¿|ğŸ’¡|ğŸ—ƒï¸|ğŸ”Š|ğŸ”‡|ğŸ™ˆ|ğŸ¤¡|ğŸ¥…|âœ…|ğŸ”|âš—ï¸|ğŸ‘½|ğŸšš|ğŸ“„|ğŸ’¬|ğŸ—‚ï¸|ğŸ”ˆ|ğŸŒ)?[ ]?(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,50}"

# Verifica se a mensagem segue o padrÃ£o
if [[ $commit_msg =~ $conventional_pattern ]]; then
    print_success "Mensagem de commit vÃ¡lida!"
    
    # VerificaÃ§Ãµes adicionais
    first_line=$(echo "$commit_msg" | head -n1)
    word_count=$(echo "$first_line" | wc -w)
    
    # RecomendaÃ§Ã£o: primeira linha com no mÃ¡ximo 4 palavras (excluindo tipo e escopo)
    if [ $word_count -gt 6 ]; then
        print_warning "RecomendaÃ§Ã£o: A primeira linha tem muitas palavras ($word_count). Considere usar no mÃ¡ximo 4 palavras apÃ³s o tipo."
    fi
    
    # Verifica se tem emoji
    if [[ ! $commit_msg =~ ^(ğŸ‰|ğŸš€|âœ¨|ğŸ›|ğŸ”§|ğŸ“|ğŸ’„|ğŸ”¥|â™»ï¸|âš¡|ğŸ¨|ğŸ“¦|ğŸ”’|ğŸš¨|ğŸ—ï¸|ğŸ’š|ğŸ‘·|ğŸ“ˆ|ğŸ”–|ğŸš‘|ğŸ’¥|ğŸ±|â™¿|ğŸ’¡|ğŸ—ƒï¸|ğŸ”Š|ğŸ”‡|ğŸ™ˆ|ğŸ¤¡|ğŸ¥…|âœ…|ğŸ”|âš—ï¸|ğŸ‘½|ğŸšš|ğŸ“„|ğŸ’¬|ğŸ—‚ï¸|ğŸ”ˆ|ğŸŒ) ]]; then
        print_info "Dica: Considere adicionar um emoji no inÃ­cio da mensagem para melhor visualizaÃ§Ã£o."
    fi
    
    exit 0
else
    print_error "Mensagem de commit invÃ¡lida!"
    echo ""
    print_info "Formato esperado: [emoji] tipo(escopo): descriÃ§Ã£o"
    echo ""
    echo -e "${BLUE}Tipos vÃ¡lidos:${NC}"
    echo "  â€¢ feat     - Nova funcionalidade"
    echo "  â€¢ fix      - CorreÃ§Ã£o de bug"
    echo "  â€¢ docs     - DocumentaÃ§Ã£o"
    echo "  â€¢ style    - FormataÃ§Ã£o, estilo"
    echo "  â€¢ refactor - RefatoraÃ§Ã£o de cÃ³digo"
    echo "  â€¢ perf     - Melhoria de performance"
    echo "  â€¢ test     - Testes"
    echo "  â€¢ build    - Sistema de build"
    echo "  â€¢ ci       - IntegraÃ§Ã£o contÃ­nua"
    echo "  â€¢ chore    - Tarefas de manutenÃ§Ã£o"
    echo "  â€¢ revert   - Reverter commit"
    echo ""
    echo -e "${BLUE}Exemplos vÃ¡lidos:${NC}"
    echo "  âœ¨ feat: adicionar login de usuÃ¡rio"
    echo "  ğŸ› fix(auth): corrigir validaÃ§Ã£o de token"
    echo "  ğŸ“ docs: atualizar README"
    echo "  ğŸ”§ chore: configurar husky"
    echo ""
    echo -e "${BLUE}Emojis recomendados:${NC}"
    echo "  âœ¨ feat   ğŸ› fix    ğŸ“ docs   ğŸ’„ style"
    echo "  â™»ï¸  refactor âš¡ perf  âœ… test  ğŸ“¦ build"
    echo "  ğŸ’š ci     ğŸ”§ chore  ğŸ”¥ remove ğŸš‘ hotfix"
    echo ""
    exit 1
fi